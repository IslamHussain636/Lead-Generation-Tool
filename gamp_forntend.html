<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps Business Scraper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
        }
        
        .sidebar {
            width: 380px;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .sidebar-header h1 {
            font-size: 1.6rem;
            margin-bottom: 8px;
        }
        
        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .form-container {
            padding: 25px;
            flex: 1;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .range-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .range-option {
            position: relative;
        }
        
        .range-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }
        
        .range-option label {
            display: block;
            padding: 12px 8px;
            text-align: center;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        
        .range-option input[type="radio"]:checked + label {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .scrape-btn {
            width: 100%;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 16px 20px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
            margin-top: 20px;
        }
        
        .scrape-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #229954, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }
        
        .scrape-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .progress-section {
            padding: 20px 25px;
            border-top: 1px solid #e1e8ed;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e8ed;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 0.9rem;
            color: #7f8c8d;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .results-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .results-header {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .results-stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: none;
        }
        
        .download-btn:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
        }
        
        .results-table-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .results-table th {
            background: #f8f9fa;
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
            position: sticky;
            top: 0;
        }
        
        .results-table td {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
        
        .results-table tr:hover {
            background: #f8f9fa;
        }
        
        .business-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .rating {
            color: #f39c12;
            font-weight: 500;
        }
        
        .contact-link {
            color: #3498db;
            text-decoration: none;
        }
        
        .contact-link:hover {
            text-decoration: underline;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #7f8c8d;
            text-align: center;
            padding: 50px;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .warning-banner {
            background: #f39c12;
            color: white;
            padding: 12px 25px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="warning-banner">
            Transforming chaos into clarity
        </div>
        
        <div class="sidebar-header">
            <h1>üó∫Ô∏è Data Scraper</h1>
            <p>Extract business across the Globe</p>
        </div>
        
        <div class="form-container">
            <div id="errorMessage" class="error-message"></div>
            
            <form id="scrapeForm">
                <div class="form-group">
                    <label for="location">Location/City *</label>
                    <input type="text" id="location" name="location" placeholder="e.g., New York, Atlanta, London" required>
                </div>
                
                <div class="form-group">
                    <label for="state">State/Province</label>
                    <input type="text" id="state" name="state" placeholder="e.g., GA, CA, Ontario (optional)">
                </div>
                
                <div class="form-group">
                    <label for="country">Country</label>
                    <select id="country" name="country">
                        <option value="">Select Country</option>
                        <!-- Will be populated by JavaScript -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="businessType">Business Type *</label>
                    <select id="businessType" name="businessType" required>
                        <option value="">Select Business Type</option>
                        <!-- Will be populated by JavaScript -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Maximum Results</label>
                    <div class="range-selector">
                        <div class="range-option">
                            <input type="radio" id="range10" name="maxResults" value="10">
                            <label for="range10">10</label>
                        </div>
                        <div class="range-option">
                            <input type="radio" id="range20" name="maxResults" value="20">
                            <label for="range20">20</label>
                        </div>
                        <div class="range-option">
                            <input type="radio" id="range50" name="maxResults" value="50" checked>
                            <label for="range50">50</label>
                        </div>
                        <div class="range-option">
                            <input type="radio" id="range80" name="maxResults" value="80">
                            <label for="range80">80</label>
                        </div>
                        <div class="range-option">
                            <input type="radio" id="range100" name="maxResults" value="100">
                            <label for="range100">100</label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="scrape-btn" id="scrapeBtn">
                    üöÄ Start Scraping
                </button>
            </form>
        </div>
        
        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Initializing...</div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="results-container">
            <div class="results-header">
                <div class="results-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="totalCount">0</span>
                        <span class="stat-label">Total Results</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="emailCount">0</span>
                        <span class="stat-label">With Emails</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="websiteCount">0</span>
                        <span class="stat-label">With Websites</span>
                    </div>
                </div>
                <button class="download-btn" id="downloadBtn">üì• Download CSV</button>
            </div>
            
            <div class="results-table-container" id="resultsContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üè¢</div>
                    <h3>No Data Yet</h3>
                    <p>Configure your search parameters and click "Start Scraping" to begin extracting business data from Google Maps.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let currentJobId = null;
        let pollInterval = null;
        let currentResults = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadCountries();
            loadBusinessTypes();
            setupEventListeners();
        });

        async function loadCountries() {
            try {
                const response = await fetch(`${API_BASE_URL}/countries`);
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('country');
                    data.countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country;
                        option.textContent = country;
                        select.appendChild(option);
                    });
                    
                    // Set USA as default
                    select.value = 'USA';
                }
            } catch (error) {
                console.error('Failed to load countries:', error);
            }
        }

        async function loadBusinessTypes() {
            try {
                const response = await fetch(`${API_BASE_URL}/business-types`);
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('businessType');
                    data.business_types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load business types:', error);
            }
        }

        function setupEventListeners() {
            document.getElementById('scrapeForm').addEventListener('submit', handleScraping);
            document.getElementById('downloadBtn').addEventListener('click', downloadResults);
        }

        async function handleScraping(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const location = formData.get('location').trim();
            const state = formData.get('state').trim();
            const country = formData.get('country').trim();
            const businessType = formData.get('businessType').trim();
            const maxResults = parseInt(formData.get('maxResults'));
            
            if (!location) {
                showError('Please enter a location.');
                return;
            }
            
            if (!businessType) {
                showError('Please select a business type.');
                return;
            }
            
            hideError();
            startScraping(location, state, country, businessType, maxResults);
        }

        async function startScraping(location, state, country, businessType, maxResults) {
            try {
                showProgress(true);
                updateProgress(5, 'Starting scraper...');
                
                const response = await fetch(`${API_BASE_URL}/scrape`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        location: location,
                        state: state,
                        country: country,
                        business_type: businessType,
                        max_results: maxResults
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to start scraping');
                }
                
                currentJobId = data.job_id;
                pollJobStatus();
                
            } catch (error) {
                showError('Error starting scraping: ' + error.message);
                showProgress(false);
            }
        }

        async function pollJobStatus() {
            if (!currentJobId) return;
            
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/status/${currentJobId}`);
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to get status');
                    }
                    
                    updateProgress(data.progress, getProgressMessage(data.status, data.progress));
                    
                    if (data.status === 'completed') {
                        clearInterval(pollInterval);
                        await loadResults();
                        showProgress(false);
                    } else if (data.status === 'failed') {
                        clearInterval(pollInterval);
                        showError('Scraping failed: ' + (data.error_message || 'Unknown error'));
                        showProgress(false);
                    }
                } catch (error) {
                    clearInterval(pollInterval);
                    showError('Error checking status: ' + error.message);
                    showProgress(false);
                }
            }, 3000);
        }

        async function loadResults() {
            try {
                const response = await fetch(`${API_BASE_URL}/results/${currentJobId}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load results');
                }
                
                currentResults = data.results;
                displayResults(data.results);
                
            } catch (error) {
                showError('Error loading results: ' + error.message);
            }
        }

        function displayResults(results) {
            updateStats(results);
            
            const container = document.getElementById('resultsContainer');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üòî</div>
                        <h3>No Results Found</h3>
                        <p>No businesses found for your search criteria. Try adjusting your parameters.</p>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Business Name</th>
                            <th>Rating</th>
                            <th>Category</th>
                            <th>Address</th>
                            <th>Phone</th>
                            <th>Website</th>
                            <th>Email</th>
                            <th>LinkedIn</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach(business => {
                tableHTML += `
                    <tr>
                        <td class="business-name">${business.name || 'N/A'}</td>
                        <td class="rating">${business.rating || 'N/A'}</td>
                        <td>${business.category || 'N/A'}</td>
                        <td>${business.address || 'N/A'}</td>
                        <td>${business.phone ? `<a href="tel:${business.phone}" class="contact-link">${business.phone}</a>` : 'N/A'}</td>
                        <td>${business.website ? `<a href="${business.website}" target="_blank" class="contact-link">${business.website}</a>` : 'N/A'}</td>
                        <td>${business.email ? `<a href="mailto:${business.email}" class="contact-link">${business.email}</a>` : 'N/A'}</td>
                        <td>${business.linkedin ? `<a href="${business.linkedin}" target="_blank" class="contact-link">LinkedIn</a>` : 'N/A'}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            document.getElementById('downloadBtn').style.display = 'block';
        }

        function updateStats(results) {
            const totalCount = results.length;
            const emailCount = results.filter(r => r.email && r.email.trim() !== '').length;
            const websiteCount = results.filter(r => r.website && r.website.trim() !== '').length;
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('emailCount').textContent = emailCount;
            document.getElementById('websiteCount').textContent = websiteCount;
        }

        function downloadResults() {
            if (!currentJobId) {
                showError('No data available to download.');
                return;
            }
            
            const downloadUrl = `${API_BASE_URL}/download/${currentJobId}`;
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showProgress(show) {
            const progressSection = document.getElementById('progressSection');
            const scrapeBtn = document.getElementById('scrapeBtn');
            
            progressSection.style.display = show ? 'block' : 'none';
            scrapeBtn.disabled = show;
            
            if (show) {
                scrapeBtn.textContent = 'Scraping...';
            } else {
                scrapeBtn.textContent = 'üöÄ Start Scraping';
            }
        }

        function updateProgress(percentage, message) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = message;
        }

        function getProgressMessage(status, progress) {
            if (status === 'pending') return 'Queued for processing...';
            if (status === 'running') {
                if (progress < 20) return 'Initializing browser...';
                if (progress < 40) return 'Searching Google Maps...';
                if (progress < 90) return 'Extracting business data...';
                return 'Finalizing results...';
            }
            if (status === 'completed') return 'Scraping completed!';
            if (status === 'failed') return 'Scraping failed';
            return 'Processing...';
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            setTimeout(() => {
                hideError();
            }, 5000);
        }

        function hideError() {
            const errorElement = document.getElementById('errorMessage');
            errorElement.style.display = 'none';
        }
    </script>
</body>
</html>